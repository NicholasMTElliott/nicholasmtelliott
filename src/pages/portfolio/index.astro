---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'

const companyEntries = (await getCollection('company')).sort(
  (a, b) => b.data.startdate.getTime() - a.data.startdate.getTime(),
)

const renderedCompanyEntries = await Promise.all(
  companyEntries.map(async company => {
    const { Content } = await render(company)

    return {
      company,
      Content,
    }
  }),
)

const formatMonthYear = (date: Date) =>
  `${date.toLocaleString('en-US', { month: 'short' })} ${date.getFullYear()}`
---

<BaseLayout title="Nicholas M. T. Elliott | Portfolio">
  <section class="portfolio">
    <aside class="card timeline">
      <h2>Experience Timeline</h2>
      <ul>
        {
          companyEntries.map(company => (
            <li>
              <a href={`#${company.data.key}`}>
                <strong>{company.data.title}</strong>
                <span>
                  {formatMonthYear(company.data.startdate)} - {formatMonthYear(company.data.enddate)}
                </span>
              </a>
            </li>
          ))
        }
      </ul>
    </aside>

    <div class="entries">
      {
        renderedCompanyEntries.map(({ company, Content }) => (
          <article class="card" id={company.data.key}>
            <h3>{company.data.title}</h3>
            <p class="period">
              {formatMonthYear(company.data.startdate)} - {formatMonthYear(company.data.enddate)}
            </p>
            <div class="entry-body">
              <Content />
            </div>
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>

<style lang="scss">
  .portfolio {
    display: grid;
    grid-template-columns: minmax(220px, 280px) 1fr;
    gap: 1rem;
    align-items: start;
  }

  .timeline {
    position: sticky;
    top: 5.5rem;
  }

  .timeline h2 {
    margin: 0 0 0.75rem;
    font-size: 1rem;
  }

  .timeline ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
  }

  .timeline a {
    color: inherit;
    text-decoration: none;
    display: grid;
    gap: 0.2rem;
  }

  .timeline span {
    color: var(--muted);
    font-size: 0.86rem;
  }

  .entries {
    display: grid;
    gap: 1rem;
  }

  .entries h3 {
    margin: 0;
  }

  .period {
    margin-top: 0.35rem;
    color: var(--muted);
  }

  .entry-body :global(p:first-child) {
    margin-top: 0;
  }

  .entry-body :global(p:last-child) {
    margin-bottom: 0;
  }

  @media (max-width: 900px) {
    .portfolio {
      grid-template-columns: 1fr;
    }

    .timeline {
      position: static;
    }
  }
</style>
