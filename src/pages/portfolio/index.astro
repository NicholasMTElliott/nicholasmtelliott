---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'

const companyEntries = (await getCollection('company')).sort(
  (a, b) => {
    const aEnd = a.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY
    const bEnd = b.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY

    if (aEnd !== bEnd) {
      return bEnd - aEnd
    }

    return b.data.startDate.getTime() - a.data.startDate.getTime()
  },
)

const roleEntries = await getCollection('role')
const projectEntries = await getCollection('project')

const rolesByCompanyKey = roleEntries.reduce<Record<string, typeof roleEntries>>((acc, role) => {
  const current = acc[role.data.companyKey] ?? []
  current.push(role)
  acc[role.data.companyKey] = current

  return acc
}, {})

Object.values(rolesByCompanyKey).forEach(roles => {
  roles.sort((a, b) => {
    const aEnd = a.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY
    const bEnd = b.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY

    if (aEnd !== bEnd) {
      return bEnd - aEnd
    }

    return b.data.startDate.getTime() - a.data.startDate.getTime()
  })
})

const projectsByRoleKey = projectEntries.reduce<Record<string, typeof projectEntries>>((acc, project) => {
  const current = acc[project.data.roleKey] ?? []
  current.push(project)
  acc[project.data.roleKey] = current

  return acc
}, {})

Object.values(projectsByRoleKey).forEach(projects => {
  projects.sort((a, b) => {
    const aEnd = a.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY
    const bEnd = b.data.endDate?.getTime() ?? Number.POSITIVE_INFINITY

    if (aEnd !== bEnd) {
      return bEnd - aEnd
    }

    const aStart = a.data.startDate?.getTime() ?? Number.NEGATIVE_INFINITY
    const bStart = b.data.startDate?.getTime() ?? Number.NEGATIVE_INFINITY

    return bStart - aStart
  })
})

const renderedCompanyEntries = await Promise.all(
  companyEntries.map(async company => {
    const { Content } = await render(company)
    const companyRoles = rolesByCompanyKey[company.data.key] ?? []

    const renderedRoles = await Promise.all(
      companyRoles.map(async role => {
        const { Content: RoleContent } = await render(role)
        const roleProjects = projectsByRoleKey[role.data.key] ?? []

        const renderedProjects = await Promise.all(
          roleProjects.map(async project => {
            const { Content: ProjectContent } = await render(project)

            return {
              project,
              ProjectContent,
            }
          }),
        )

        return {
          role,
          RoleContent,
          renderedProjects,
        }
      }),
    )

    return {
      company,
      Content,
      renderedRoles,
    }
  }),
)

const formatMonthYear = (date: Date) =>
  `${date.toLocaleString('en-US', { month: 'short' })} ${date.getFullYear()}`

const formatPeriod = (startDate: Date, endDate?: Date) => {
  const start = formatMonthYear(startDate)
  const end = endDate ? formatMonthYear(endDate) : 'Present'

  return `${start} - ${end}`
}
---

<BaseLayout title="Nicholas M. T. Elliott | Portfolio">
  <section class="portfolio">
    <aside class="card timeline">
      <h2>Experience Timeline</h2>
      <ul>
        {
          companyEntries.map(company => (
            <li>
              <a href={`#${company.data.key}`}>
                <strong>{company.data.title}</strong>
                <span>{formatPeriod(company.data.startDate, company.data.endDate)}</span>
              </a>
            </li>
          ))
        }
      </ul>
    </aside>

    <div class="entries">
      {
        renderedCompanyEntries.map(({ company, Content, renderedRoles }) => (
          <article class="card" id={company.data.key}>
            <h3>{company.data.title}</h3>
            <p class="period">{formatPeriod(company.data.startDate, company.data.endDate)}</p>
            <div class="entry-body">
              <Content />
            </div>

            {renderedRoles.length > 0 && (
              <section class="roles">
                <div class="role-list">
                  {
                    renderedRoles.map(({ role, RoleContent, renderedProjects }) => (
                      <>
                      
                        <h4>{role.data.title}</h4>
                      <article class="role-item">
                        {renderedProjects.length > 0 && (
                          <section class="projects">
                            <h5>Projects</h5>
                            <div class="project-list">
                              {
                                renderedProjects.map(({ project, ProjectContent }) => (
                                  <article class="project-item">
                                    <p class="project-name">{project.data.name}</p>
                                    {project.data.startDate && (
                                      <p class="project-period">{formatPeriod(project.data.startDate, project.data.endDate)}</p>
                                    )}
                                    <div class="project-body">
                                      <ProjectContent />
                                    </div>
                                  </article>
                                ))
                              }
                            </div>
                          </section>
                        )}
                      </article>
                      </>
                    ))
                  }
                </div>
              </section>
            )}
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>

<style lang="scss">
  .portfolio {
    display: grid;
    grid-template-columns: minmax(220px, 280px) 1fr;
    gap: clamp(0.9rem, 2vw, 1.35rem);
    align-items: start;
  }

  .timeline {
    position: sticky;
    top: 5.1rem;
  }

  .timeline h2 {
    margin: 0 0 0.75rem;
    font-size: 1rem;
  }

  .timeline ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
  }

  .timeline a {
    color: inherit;
    text-decoration: none;
    display: grid;
    gap: 0.2rem;
    border-radius:0;
    padding: 0.38rem 0.42rem;
    border: 1px solid transparent;
    transition: background-color 120ms ease, border-color 120ms ease;
  }

  .timeline a:hover {
    background: color-mix(in srgb, var(--surface-alt) 78%, var(--accent) 22%);
    border-color: color-mix(in srgb, var(--border) 65%, var(--accent) 35%);
  }

  .timeline span {
    color: var(--muted);
    font-size: 0.86rem;
  }

  .entries {
    display: grid;
    gap: 1rem;
  }

  .entries h3 {
    margin: 0;
  }

  .period {
    margin-top: 0.35rem;
    color: var(--muted);
  }

  .entry-body :global(p:first-child) {
    margin-top: 0;
  }

  .entry-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .roles {
    margin-top: 1.1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }

  .roles h4,
  .role-item h5,
  .projects h6 {
    margin: 0;
  }

  .project-name {
    margin: 0;
    font-weight: 600;
  }

  .role-list {
    display: grid;
    gap: 0.9rem;
    margin-top: 0.75rem;
  }

  .role-item {
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 0;
    padding: 0.85rem;
  }

  .role-period {
    margin: 0.25rem 0 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .role-body :global(p:first-child) {
    margin-top: 0.6rem;
  }

  .role-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .projects {
  }

  .project-list {
    display: grid;
    gap: 0.9rem;
    margin-top: 0.75rem;
  }

  .project-item {
    padding: 0.85rem;
    padding-left: 0;
  }

  .project-period {
    margin: 0.25rem 0 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .project-body :global(p:first-child) {
    margin-top: 0.6rem;
  }

  .project-body :global(p:last-child) {
    margin-bottom: 0;
  }

  @media (max-width: 900px) {
    .portfolio {
      grid-template-columns: 1fr;
    }

    .timeline {
      position: static;
    }

    .timeline ul {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.5rem;
    }
  }

  @media (max-width: 640px) {
    .timeline ul {
      display: flex;
      overflow-x: auto;
      padding-bottom: 0.25rem;
      gap: 0.45rem;
      scroll-snap-type: x proximity;
    }

    .timeline li {
      min-width: 220px;
      scroll-snap-align: start;
    }

    .entries {
      gap: 0.8rem;
    }

    .project-item {
      padding: 0.72rem;
    }
  }
</style>
